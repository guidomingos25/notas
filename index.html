<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Relat√≥rio ‚Äì Almoxarifado + Datas</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

<style>
body { font-family: 'Inter', sans-serif; background: #f4f6f8; margin:0; padding:25px; font-size:14px; color:#333; transition: all 0.3s; }
h1 { text-align:center; margin-bottom:20px; font-size:26px; font-weight:600; color:#1a237e; }
.container { max-width:1080px; margin:auto; background:#fff; padding:25px; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,0.1); transition: all 0.3s; }
.filtros-botoes { display:flex; gap:12px; flex-wrap:wrap; margin-bottom:20px; }
.filtros-botoes input, .filtros-botoes select, .filtros-botoes button { font-size:13px; padding:8px 12px; flex:1; min-width:140px; border-radius:8px; border:1px solid #cfd8dc; transition: all 0.2s; outline:none; }
.filtros-botoes input:focus, .filtros-botoes select:focus { border-color:#1976d2; box-shadow:0 0 5px rgba(25,118,210,0.3); }
button { background:#1976d2; color:white; cursor:pointer; border:none; border-radius:8px; font-weight:500; transition: all 0.2s; }
button:hover { background:#1257a5; transform:translateY(-2px); box-shadow:0 4px 12px rgba(0,0,0,0.15); }
details { margin-top:12px; background:#e8f0fe; border:1px solid #c5d3f0; border-radius:10px; padding:12px; transition: all 0.2s; }
details summary { cursor:pointer; padding:8px; font-size:16px; font-weight:600; color:#0d47a1; }
details[open] { background:#dbe6fc; }
.tabela-scroll { max-height:360px; overflow-y:auto; overflow-x:auto; margin-top:12px; border:1px solid #c5d2f0; border-radius:10px; background:white; padding:8px; }
table { width:100%; border-collapse:collapse; font-size:13px; min-width:900px; transition: all 0.3s; }
th, td { padding:8px 10px; border:1px solid #ccc; text-align:center; white-space:nowrap; }
th { background:#1976d2; color:white; font-weight:600; cursor:pointer; }
tr:nth-child(even) { background:#f1f5f9; }
tr:hover { background:#e3f2fd; }
.summary-resumo { margin-bottom:8px; font-size:13px; font-weight:600; color:#0d47a1; }

/* ‚≠ê ADI√á√ÉO ‚Äî APENAS ISSO OCULTA O CAMINHO DO ARQUIVO */
input[type="file"] {
    color: transparent;
}
input[type="file"]::file-selector-button {
    color: #333;
}

/* ====== Modal / Popup styles for chart ====== */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}
.modal {
  width: 900px;
  max-width: calc(100% - 40px);
  background: #fff;
  border-radius: 12px;
  padding: 18px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}
.modal-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:12px;
}
.modal-title { font-weight:700; color:#0d47a1; }
.modal-close {
  background:#e0e0e0;
  border:none;
  padding:6px 10px;
  border-radius:8px;
  cursor:pointer;
}
.modal-body { width:100%; }
.chart-legend { margin-top:8px; font-size:13px; color:#333; }
@media (max-width:640px){
  .modal { padding:12px; }
}
</style>
</head>

<body>
<div class="container">
    <h1>üìå Relat√≥rio por Almoxarifado.</h1>

    <div class="filtros-botoes">

        <input type="file" id="fileInput" accept=".xlsx">

        <select id="filtroAlmox"><option value="">Almoxarifado</option></select>

        <select id="filtroRange"><option value="">Range de Dias</option></select>

        <input type="number" id="diasCorte" placeholder="Dias de Corte" min="1">

        <button onclick="baixarExcel()">üíæ Excel</button>
        <button onclick="gerarRelatorioImpressao()">üñ®Ô∏è Imprimir</button>
        <button onclick="toggleDetalhes()" id="btnToggle">‚¨ÜÔ∏è Expandir/Recolher Todos</button>
        <button onclick="mostrarResumoGeral()">üìä Resumo Geral</button>

    </div>

    <div id="resultado"></div>
</div>


<script>
let dfGlobal = [];
let ordenacao = { coluna: null, asc: true };

const COLUNAS_DATA = [
    "Data de Check in","Data de Entrada da Nota","Data Inventario",
    "Ultimo Inventario Filial","Data de Cria√ß√£o da Coleta",
    "Data Programacao","Dt Final Entrega","Dt Limite Embarque"
];

const COLUNAS_EXCEL = [
    "Data de Check in","Data de Entrada da Nota","Nota","Numero OEF","Range de Dias",
    "Fornecedor","Almoxarifado","CTE","ONU","End. WMS","Mercadoria","Peso","Volumes",
    "Data Inventario","Ultimo Inventario Filial","Status no Inventario"
];

function formatDateBR(date){
    if(!date) return "";
    const d = String(date.getDate()).padStart(2,"0");
    const m = String(date.getMonth()+1).padStart(2,"0");
    return `${d}/${m}/${date.getFullYear()}`;
}

/*
  parseDateLocal aprimorada:
  - aceita Date objects,
  - n√∫meros serial do Excel,
  - strings dd/mm/yyyy, dd/mm/yyyy hh:mm, yyyy-mm-dd, ISO (com T),
  - retorna null quando n√£o for data v√°lida.
  Normaliza para meia-noite (somente data).
*/
function parseDateLocal(val){
    if(val === null || val === undefined) return null;

    // J√° √© Date
    if(val instanceof Date && !isNaN(val)) {
        return new Date(val.getFullYear(), val.getMonth(), val.getDate());
    }

    // Excel serial number
    if(typeof val === "number" && !isNaN(val)){
        const d = new Date(Math.round((val - 25569) * 86400 * 1000));
        if(!isNaN(d)) return new Date(d.getFullYear(), d.getMonth(), d.getDate());
        return null;
    }

    if(typeof val === "string"){
        const s = val.trim();

        // dd/mm/yyyy ou dd/mm/yyyy hh:mm
        if(s.includes("/")){
            const parts = s.split(" ");
            const datePart = parts[0];
            const comps = datePart.split("/");
            if(comps.length === 3){
                const d = parseInt(comps[0],10);
                const m = parseInt(comps[1],10) - 1;
                const y = parseInt(comps[2],10);
                if(!isNaN(d) && !isNaN(m) && !isNaN(y)){
                    return new Date(y, m, d);
                }
            }
        }

        // tenta formato ISO / yyyy-mm-dd / com hora
        const maybe = new Date(s);
        if(!isNaN(maybe)){
            return new Date(maybe.getFullYear(), maybe.getMonth(), maybe.getDate());
        }
    }

    return null;
}

document.getElementById("fileInput").addEventListener("change", async function(e){
    const file = e.target.files[0];
    if(!file) return;

    const data = await file.arrayBuffer();
    const workbook = XLSX.read(data, { cellDates:true, raw:true });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];

    let df = XLSX.utils.sheet_to_json(sheet, { raw:true, dateNF:"dd/mm/yyyy" });
    df = df.filter(l => l["Numero OEF"] && String(l["Numero OEF"]).trim() !== "");



    // Normaliza especialmente as duas colunas importantes (e as demais de data)
    df.forEach(linha => {
        linha["Data de Entrada da Nota"] = parseDateLocal(linha["Data de Entrada da Nota"]);

        // ‚≠ê AJUSTE ‚Äî SOMAR +1 DIA EM TODAS AS REGRAS E EXIBI√á√ÉO
        if (linha["Data de Entrada da Nota"] instanceof Date) {
            linha["Data de Entrada da Nota"].setDate(
                linha["Data de Entrada da Nota"].getDate() + 1
            );
        }

        linha["Data de Check in"] = parseDateLocal(linha["Data de Check in"]);

        COLUNAS_DATA.forEach(col => {
            if(col !== "Data de Entrada da Nota" && col !== "Data de Check in"){
                linha[col] = parseDateLocal(linha[col]);
            }
        });
    });

    // ‚≠ê‚≠ê‚≠ê C√ÅLCULO REAL DO RANGE DE DIAS (AQUI √â A CORRE√á√ÉO PEDIDA)
    df.forEach(linha => {
        const dEntrada = linha["Data de Entrada da Nota"] instanceof Date ? linha["Data de Entrada da Nota"] : null;
        const dCheck   = linha["Data de Check in"] instanceof Date ? linha["Data de Check in"] : null;

        let maiorData = null;

        if (dEntrada && dCheck) {
            maiorData = dEntrada > dCheck ? dEntrada : dCheck;
        } else if (dEntrada) {
            maiorData = dEntrada;
        } else if (dCheck) {
            maiorData = dCheck;
        }

        if (maiorData) {
            const hoje = new Date();
            hoje.setHours(0,0,0,0);

            const diff = Math.round((hoje - maiorData) / (1000*60*60*24));
            linha["Range de Dias"] = diff;
        } else {
            linha["Range de Dias"] = "";
        }
    });

    dfGlobal = df;
    renderTabela();
});


// ------------------- FILTROS -------------------
function preencherFiltros(df, filtroAlmoxSelecionado, filtroRangeSelecionado){
    const filtroAlmox = document.getElementById("filtroAlmox");
    const filtroRange = document.getElementById("filtroRange");

    filtroAlmox.innerHTML = `<option value="">Filtrar por Almoxarifado</option>`;
    filtroRange.innerHTML = `<option value="">Filtrar por Range de Dias</option>`;

    const val = document.getElementById("diasCorte").value;
    const corteDias = val === "" ? null : parseInt(val);

    // c√°lculo do limite SOMENTE se corteDias for v√°lido
    const hoje = new Date(); hoje.setHours(0,0,0,0);
    const limite = (corteDias !== null && !isNaN(corteDias)) ? new Date(hoje.getTime()) : null;
    if(limite) limite.setDate(hoje.getDate() - corteDias);

    const dfFiltrado = df.filter(l => {
        if(filtroAlmoxSelecionado && l["Almoxarifado"] !== filtroAlmoxSelecionado) return false;
        if(filtroRangeSelecionado && l["Range de Dias"] !== filtroRangeSelecionado) return false;

        const dEntrada = l["Data de Entrada da Nota"];
        const dCheckin = l["Data de Check in"];

        if (corteDias !== null && limite) {
            const limiteTime = limite.getTime();
            const maiorData =
                (dEntrada instanceof Date && !isNaN(dEntrada) &&
                dCheckin instanceof Date && !isNaN(dCheckin))
                    ? (dEntrada > dCheckin ? dEntrada : dCheckin)
                    : (dEntrada instanceof Date && !isNaN(dEntrada) ? dEntrada :
                    dCheckin instanceof Date && !isNaN(dCheckin) ? dCheckin : null);

            if (corteDias !== null && limite) {
                if (!maiorData) return false; // se n√£o existe data v√°lida, n√£o exibe
                return maiorData.getTime() <= limite.getTime();
            }

        }
        return true; // sem filtro de dias

    });

    const almoxSet = new Set(dfFiltrado.map(l => l["Almoxarifado"]).filter(a => a));
    const rangeSet = new Set(dfFiltrado.map(l => l["Range de Dias"]).filter(r => r));

    [...almoxSet].sort().forEach(a => {
        filtroAlmox.innerHTML += `<option value="${a}" ${filtroAlmoxSelecionado===a?'selected':''}>${a}</option>`;
    });

    [...rangeSet].sort().forEach(r => {
        filtroRange.innerHTML += `<option value="${r}" ${filtroRangeSelecionado===r?'selected':''}>${r}</option>`;
    });

    filtroAlmox.onchange = renderTabela;
    filtroRange.onchange = renderTabela;

    document.getElementById("diasCorte").onchange = renderTabela;
}


// ------------------- RENDER TABELA -------------------
function renderTabela(){
    const filtroAlmox = document.getElementById("filtroAlmox").value;
    const filtroRange = document.getElementById("filtroRange").value;

    preencherFiltros(dfGlobal, filtroAlmox, filtroRange);

    const val = document.getElementById("diasCorte").value;
    const corteDias = val === "" ? null : parseInt(val);

    const hoje = new Date(); hoje.setHours(0,0,0,0);
    const limite = (corteDias !== null && !isNaN(corteDias)) ? new Date(hoje.getTime()) : null;
    if(limite) limite.setDate(hoje.getDate() - corteDias);

    const dfFiltrado = dfGlobal.filter(l => {
        if(filtroAlmox && l["Almoxarifado"] !== filtroAlmox) return false;
        if(filtroRange && l["Range de Dias"] !== filtroRange) return false;

        const dEntrada = l["Data de Entrada da Nota"];
        const dCheckin = l["Data de Check in"];

        if (corteDias !== null && limite) {
            const limiteTime = limite.getTime();
            const maiorData =
                (dEntrada instanceof Date && !isNaN(dEntrada) &&
                dCheckin instanceof Date && !isNaN(dCheckin))
                    ? (dEntrada > dCheckin ? dEntrada : dCheckin)
                    : (dEntrada instanceof Date && !isNaN(dEntrada) ? dEntrada :
                    dCheckin instanceof Date && !isNaN(dCheckin) ? dCheckin : null);

            if (corteDias !== null && limite) {
                if (!maiorData) return false; // se n√£o existe data v√°lida, n√£o exibe
                return maiorData.getTime() <= limite.getTime();
            }

        }
        return true; // sem filtro

    });

    const todasColunas = Array.from(new Set(dfGlobal.flatMap(obj => Object.keys(obj))));
    const colunasOrdenadas = [
        "Almoxarifado","Range de Dias","Nota","Data de Entrada da Nota","Data de Check in",
        ...todasColunas.filter(c => ![
            "Almoxarifado","Range de Dias","Nota","Data de Entrada da Nota","Data de Check in"
        ].includes(c))
    ];

    const grupos = {};
    dfFiltrado.forEach(l => {
        const key = l["Almoxarifado"] || "Sem Almoxarifado";
        if(!grupos[key]) grupos[key] = [];
        grupos[key].push(l);
    });

    let html = "";
    for(const almox in grupos){
        let grupo = [...grupos[almox]];
        if(ordenacao.coluna) grupo = ordenarArray(grupo, ordenacao.coluna, ordenacao.asc);

        const notas = grupo.length;
        const totalPeso = grupo.reduce((s,l)=>s+(parseFloat(l["Peso"])||0), 0);
        const totalVolumes = grupo.reduce((s,l)=>s+(parseFloat(l["Volumes"])||0), 0);

        html += `<details><summary>üì¶ ${almox} ‚Äî ${notas} notas</summary>`;
        html += `<div class="summary-resumo">Resumo: Total Notas: ${notas} | Peso: ${totalPeso} | Volumes: ${totalVolumes}</div>`;
        html += `<div class="tabela-scroll"><table><tr>`;

        colunasOrdenadas.forEach(c => {
            html += `<th onclick="clicarCabecalho('${c}')">${c}${ordenacao.coluna===c ? (ordenacao.asc?' üîº':' üîΩ') : ''}</th>`;
        });

        html += `</tr>`;

        grupo.forEach(l => {
            html += "<tr>" + colunasOrdenadas.map(c=>{
                const val = l[c];
                return COLUNAS_DATA.includes(c)
                    ? `<td>${formatDateBR(val)}</td>`
                    : `<td>${val ?? ""}</td>`;
            }).join("") + "</tr>";
        });

        html += `</table></div></details><br>`;
    }

    document.getElementById("resultado").innerHTML = html;

    document.querySelectorAll("details").forEach(d => d.open = true);
    atualizarBotaoToggle();

}

function ordenarArray(arr, coluna, asc = true){
    return arr.sort((a,b)=>{
        let A = a[coluna] ?? "";
        let B = b[coluna] ?? "";

        if(A instanceof Date && B instanceof Date) return asc ? A-B : B-A;

        const nA = parseFloat(A);
        const nB = parseFloat(B);
        if(!isNaN(nA) && !isNaN(nB)) return asc ? nA-nB : nB-nA;

        A = String(A).toLowerCase();
        B = String(B).toLowerCase();
        return asc ? A.localeCompare(B) : B.localeCompare(A);
    });
}


// ------------------- ORDENA√á√ÉO CABE√áALHO -------------------
function clicarCabecalho(coluna){
    if(ordenacao.coluna === coluna) ordenacao.asc = !ordenacao.asc;
    else { ordenacao.coluna = coluna; ordenacao.asc = true; }
    renderTabela();
}


// ------------------- ABRIR / FECHAR TODOS -------------------
function toggleDetalhes(){
    const details = document.querySelectorAll("details");
    const abrir = Array.from(details).some(d => !d.open);
    details.forEach(d => d.open = abrir);
    atualizarBotaoToggle();
}

function atualizarBotaoToggle(){
    const all = document.querySelectorAll("details");
    const btn = document.getElementById("btnToggle");
    const todosAbertos = Array.from(all).every(d => d.open);
    btn.innerText = todosAbertos ? "‚¨áÔ∏è Recolher Todos" : "‚¨ÜÔ∏è Expandir Todos";
}


// ------------------- EXPORTAR EXCEL -------------------
function baixarExcel(){
    const data = [];

    document.querySelectorAll("details").forEach(detail => {
        if(detail.open){
            const table = detail.querySelector("table");
            const rows = Array.from(table.querySelectorAll("tr")).slice(1);

            rows.forEach(tr => {
                const rowData = Array.from(tr.querySelectorAll("td")).map(td => td.innerText);
                const obj = {};

                COLUNAS_EXCEL.forEach(col => {
                    const index = Array.from(table.querySelectorAll("th"))
                        .findIndex(th => th.innerText === col);
                    obj[col] = index >= 0 ? rowData[index] : "";
                });

                data.push(obj);
            });
        }
    });

    if(data.length === 0){ alert("Nenhum relat√≥rio aberto para exportar!"); return; }

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Relatorio");
    XLSX.writeFile(wb, "relatorio_aberto.xlsx");
}


// ------------------- IMPRESS√ÉO -------------------
function gerarRelatorioImpressao(){
    const grupos = {};

    document.querySelectorAll("details").forEach(detail => {
        if(detail.open){
            const table = detail.querySelector("table");
            const almox = detail.querySelector("summary").innerText.split(' ‚Äî ')[0].replace("üì¶ ","");

            if(!grupos[almox]) grupos[almox] = [];

            const rows = Array.from(table.querySelectorAll("tr")).slice(1);

            rows.forEach(tr => {
                const rowData = Array.from(tr.querySelectorAll("td")).map(td => td.innerText);
                const obj = {};

                COLUNAS_EXCEL.forEach(col => {
                    const idx = Array.from(table.querySelectorAll("th"))
                        .findIndex(th => th.innerText === col);
                    obj[col] = idx >= 0 ? rowData[idx] : "";
                });

                grupos[almox].push(obj);
            });
        }
    });

    if(Object.keys(grupos).length === 0){
        alert("Nenhum relat√≥rio aberto para imprimir!");
        return;
    }

    let htmlPrint = `<html><head><title>Relat√≥rio para Impress√£o</title><style>
        table { width:100%; border-collapse:collapse; font-size:10px; margin-bottom:25px; }
        th, td { border:1px solid #000; padding:3px; text-align:center; }
        th { background:#1976d2; color:white; font-weight:600; }
        h3 { margin-top:15px; margin-bottom:5px; font-size:12px; }
        h2 { font-size:14px; text-align:center; margin-bottom:15px; }
    </style></head><body>`;

    htmlPrint += `<h2>üìå Relat√≥rio por Almoxarifado</h2>`;

    for(const almox in grupos){
        htmlPrint += `<h3>üì¶ ${almox} ‚Äî ${grupos[almox].length} notas</h3>`;
        htmlPrint += `<table><tr>${COLUNAS_EXCEL.map(c=>`<th>${c}</th>`).join("")}</tr>`;

        grupos[almox].forEach(r => {
            htmlPrint += `<tr>${COLUNAS_EXCEL.map(c=>`<td>${r[c] ?? ""}</td>`).join("")}</tr>`;
        });

        htmlPrint += `</table>`;
    }

    htmlPrint += `</body></html>`;

    const w = window.open();
    w.document.write(htmlPrint);
    w.document.close();
    w.focus();
    w.print();
}



/*
====================================================
‚≠ê PATCH ‚Äî IMPEDIR FECHAMENTO AO CLICAR NO <TH> ‚≠ê
====================================================
*/

document.addEventListener("click", function(e) {
    if (e.target.tagName === "TH") {
        e.stopPropagation();
    }
}, true);

document.addEventListener("click", function (e) {
    document.querySelectorAll("details").forEach(det => {
        const summary = det.querySelector("summary");
        const clicouResumo = e.target === summary || summary.contains(e.target);

        if (clicouResumo) {
            e.preventDefault();
            det.open = !det.open;
        }
    });
});

document.addEventListener("toggle", function (e) {
    if (e.target.tagName === "DETAILS") {
        e.stopImmediatePropagation();
    }
}, true);

/*
====================================================
|  Fun√ß√µes extra para gerar o chart (popup)       |
====================================================
*/


// Retorna os dados atualmente exibidos (mesma l√≥gica de filtro do renderTabela)
function getCurrentFilteredData(){
    const filtroAlmox = document.getElementById("filtroAlmox").value;
    const filtroRange = document.getElementById("filtroRange").value;
    const val = document.getElementById("diasCorte").value;
    const corteDias = val === "" ? null : parseInt(val);

    const hoje = new Date(); hoje.setHours(0,0,0,0);
    const limite = (corteDias !== null && !isNaN(corteDias)) ? new Date(hoje.getTime()) : null;
    if(limite) limite.setDate(hoje.getDate() - corteDias);

    const filtered = dfGlobal.filter(l => {
        if(filtroAlmox && l["Almoxarifado"] !== filtroAlmox) return false;
        if(filtroRange && l["Range de Dias"] !== filtroRange) return false;

        const dEntrada = l["Data de Entrada da Nota"];
        const dCheckin = l["Data de Check in"];

        if (corteDias !== null && limite) {
            const maiorData =
                (dEntrada instanceof Date && !isNaN(dEntrada) &&
                dCheckin instanceof Date && !isNaN(dCheckin))
                    ? (dEntrada > dCheckin ? dEntrada : dCheckin)
                    : (dEntrada instanceof Date && !isNaN(dEntrada) ? dEntrada :
                    dCheckin instanceof Date && !isNaN(dCheckin) ? dCheckin : null);

            if (!maiorData) return false;
            return maiorData.getTime() <= limite.getTime();
        }
        return true;
    });

    return filtered;
}

// Constr√≥i a matriz de contagens: almoxarifado x range
function buildChartCounts(filteredData){
    // Ranges fixos solicitados
    const rangeGroups = {
        "0‚Äì5 dias":   d => d >= 0 && d <= 5,
        "6‚Äì10 dias":  d => d >= 6 && d <= 10,
        "11‚Äì20 dias": d => d >= 11 && d <= 20,
        "21+ dias":   d => d >= 21
    };

    // Lista de almoxarifados ordenados
    const almoxs = Array.from(
        new Set(filteredData.map(r => r["Almoxarifado"] || "Sem Almoxarifado"))
    ).sort();

    // Criar estrutura de contagem zerada
    const counts = {};
    Object.keys(rangeGroups).forEach(r => {
        counts[r] = almoxs.map(() => 0);
    });

    // Preencher contagens corretamente
    filteredData.forEach(row => {
        const alm = row["Almoxarifado"] || "Sem Almoxarifado";
        const dias = row["Range de Dias"];

        if (dias === "" || dias === null || isNaN(dias)) return;

        const i = almoxs.indexOf(alm);
        if (i < 0) return;

        for (const group in rangeGroups) {
            if (rangeGroups[group](dias)) {
                counts[group][i]++;
                break;
            }
        }
    });

    return {
        almoxs,
        ranges: Object.keys(rangeGroups),
        counts
    };
}


let currentChart = null;

// Cria e abre modal + chart
function openChartModal(){
    const filtered = getCurrentFilteredData();
    const { almoxs, ranges, counts } = buildChartCounts(filtered);

    // se n√£o tem dados, avisa e retorna
    if(almoxs.length === 0){
        alert("Nenhum dado para exibir no gr√°fico (verifique filtros).");
        return;
    }

    // criar overlay modal
    const overlay = document.createElement("div");
    overlay.className = "modal-overlay";
    overlay.id = "chart-modal-overlay";

    // modal HTML
    overlay.innerHTML = `
      <div class="modal" role="dialog" aria-modal="true">
        <div class="modal-header">
          <div class="modal-title">Resumo Geral ‚Äî Gr√°fico por Almoxarifado / Range de Dias</div>
          <button class="modal-close" id="chart-modal-close">Fechar</button>
        </div>
        <div class="modal-body">
          <canvas id="resumoChart" style="width:100%;max-height:420px"></canvas>
          <div class="chart-legend" id="chart-legend"></div>
        </div>
      </div>
    `;

    document.body.appendChild(overlay);

    // montar datasets para Chart.js (cada range √© um dataset)
    const palette = {
    "0‚Äì5 dias":   "#1565C0", // azul forte
    "6‚Äì10 dias":  "#2E7D32", // verde escuro
    "11‚Äì20 dias": "#F9A825", // amarelo bem contrastante
    "21+ dias":   "#C62828"  // vermelho forte
    };

    const datasets = ranges.map(r => ({
        label: r,
        data: counts[r],
        backgroundColor: palette[r],
        borderColor: palette[r],
        borderWidth: 1,
        stack: "Stack 0"
    }));


    // let Chart.js decide colors: we'll not set explicit colors to keep it simple (browser default palette)
    // Create chart
    const ctx = document.getElementById("resumoChart").getContext("2d");

    // If an existing chart exists, destroy
    if(currentChart){
        try { currentChart.destroy(); } catch(e){/*ignore*/ }
        currentChart = null;
    }

    currentChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: almoxs,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { position: 'top' },
                tooltip: { enabled: true },

                // ‚≠ê R√ìTULOS DE DADOS
                datalabels: {
                    color: '#000',
                    anchor: 'center',
                    align: 'center',
                    font: { weight: 'bold', size: 11 },
                    formatter: value => (value > 0 ? value : '')
                }
            },
            scales: {
                x: { stacked: true, title: { display: true, text: 'Almoxarifado' } },
                y: { stacked: true, title: { display: true, text: 'N√∫mero de Notas' }, beginAtZero: true }
            }
        },
        plugins: [ChartDataLabels]   // ‚≠ê importante!
    });


    // build a small legend HTML (optional)
    const legendDiv = document.getElementById("chart-legend");
    legendDiv.innerHTML = ranges.map(r => `<span style="display:inline-block;margin-right:8px;padding:6px 10px;border-radius:8px;background:#f1f1f1;margin-bottom:6px;">${r}</span>`).join("");

    // close button handler
    document.getElementById("chart-modal-close").onclick = () => closeChartModal();
    overlay.onclick = (ev) => {
        if(ev.target === overlay) closeChartModal();
    };
}

function closeChartModal(){
    const overlay = document.getElementById("chart-modal-overlay");
    if(overlay){
        if(currentChart){
            try { currentChart.destroy(); } catch(e){/*ignore*/ }
            currentChart = null;
        }
        overlay.remove();
    }
}

// ---------------- Mostrar Resumo + abrir popup ----------------
function mostrarResumoGeral(){
    const existente = document.getElementById("resumo-geral-box");

    // üîÑ Se j√° existe ‚Üí remover (toggle OFF)
    if (existente) {
        existente.remove();
        // tamb√©m fecho modal se aberto
        closeChartModal();
        return;
    }

    // üîÑ Caso contr√°rio ‚Üí gerar (toggle ON)
    const details = document.querySelectorAll("details");
    let almoxCount = details.length;
    let totalNotas = 0;
    let totalPeso = 0;
    let totalVolumes = 0;

    details.forEach(det => {
        const textoResumo = det.querySelector(".summary-resumo")?.innerText || "";
        const partes = textoResumo.match(/Notas: (\d+).*Peso: ([\d.]+).*Volumes: (\d+)/);

        if(partes){
            totalNotas += parseInt(partes[1]);
            totalPeso += parseFloat(partes[2]);
            totalVolumes += parseInt(partes[3]);
        }
    });

    const resumoHTML = `
    <div id="resumo-geral-box" style="
        background:#e3f2fd;
        border:1px solid #90caf9;
        padding:12px;
        border-radius:10px;
        margin-bottom:15px;
        font-size:14px;
        font-weight:600;
        color:#0d47a1;
    ">
        üìä <strong>Resumo Geral</strong><br>
        Almoxarifados exibidos: ${almoxCount}<br>
        Total de Notas: ${totalNotas}<br>
        Peso Total: ${totalPeso.toFixed(2)}<br>
        Volumes Totais: ${totalVolumes}
    </div>`;

    document.getElementById("resultado").insertAdjacentHTML("afterbegin", resumoHTML);

    // abre modal com chart usando os dados atuais (mesma filtragem)
    openChartModal();
}


</script>
</body>
</html>
