<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Relat√≥rio ‚Äì Almoxarifado + Datas</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

<!-- SELECT2 (para multi sele√ß√£o + campo de busca) -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<style>
/* Ajuste m√≠nimo para n√£o alterar seu design */
.select2-container .select2-selection--multiple {
    min-height: 38px !important;
    border-radius: 8px !important;
    border: 1px solid #cfd8dc !important;
}
</style>


<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

<style>
body { font-family: 'Inter', sans-serif; background: #f4f6f8; margin:0; padding:25px; font-size:14px; color:#333; transition: all 0.3s; }
h1 { text-align:center; margin-bottom:20px; font-size:26px; font-weight:600; color:#1a237e; }
.container { max-width:1080px; margin:auto; background:#fff; padding:25px; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,0.1); transition: all 0.3s; }
.filtros-botoes { display:flex; gap:12px; flex-wrap:wrap; margin-bottom:20px; }
.filtros-botoes input, .filtros-botoes select, .filtros-botoes button { font-size:13px; padding:8px 12px; flex:1; min-width:140px; border-radius:8px; border:1px solid #cfd8dc; transition: all 0.2s; outline:none; }
.filtros-botoes input:focus, .filtros-botoes select:focus { border-color:#1976d2; box-shadow:0 0 5px rgba(25,118,210,0.3); }
button { background:#1976d2; color:white; cursor:pointer; border:none; border-radius:8px; font-weight:500; transition: all 0.2s; }
button:hover { background:#1257a5; transform:translateY(-2px); box-shadow:0 4px 12px rgba(0,0,0,0.15); }
details { margin-top:12px; background:#e8f0fe; border:1px solid #c5d3f0; border-radius:10px; padding:12px; transition: all 0.2s; }
details summary { cursor:pointer; padding:8px; font-size:16px; font-weight:600; color:#0d47a1; }
details[open] { background:#dbe6fc; }
.tabela-scroll { max-height:360px; overflow-y:auto; overflow-x:auto; margin-top:12px; border:1px solid #c5d2f0; border-radius:10px; background:white; padding:8px; }
table { width:100%; border-collapse:collapse; font-size:13px; min-width:900px; transition: all 0.3s; }
th, td { padding:8px 10px; border:1px solid #ccc; text-align:center; white-space:nowrap; }
th { background:#1976d2; color:white; font-weight:600; cursor:pointer; }
tr:nth-child(even) { background:#f1f5f9; }
tr:hover { background:#e3f2fd; }
.summary-resumo { margin-bottom:8px; font-size:13px; font-weight:600; color:#0d47a1; }

/* ‚≠ê ADI√á√ÉO ‚Äî APENAS ISSO OCULTA O CAMINHO DO ARQUIVO */
input[type="file"] {
    color: transparent;
}
input[type="file"]::file-selector-button {
    color: #333;
}

/* ====== Modal / Popup styles for chart ====== */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}
.modal {
  width: 1200px;
  max-width: 95vw;
  max-height: 95vh;
  background: #fff;
  border-radius: 12px;
  padding: 18px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}
.modal-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:12px;
}
.modal-title { font-weight:700; color:#0d47a1; }
.modal-close {
  background:#e0e0e0;
  border:none;
  padding:6px 10px;
  border-radius:8px;
  cursor:pointer;
}
.modal-body { width:100%; }
.chart-legend { margin-top:8px; font-size:13px; color:#333; }

/* summary area inside modal (below chart) */
.modal-summary {
  margin-top:12px;
  background:#f7fbff;
  border:1px solid #d6e9ff;
  padding:12px;
  border-radius:8px;
  font-size:13px;
  color:#0d47a1;
}
.modal-summary h4 { margin:6px 0; font-size:14px; color:#0b3a66; }
.modal-summary pre { white-space:pre-wrap; font-family:inherit; font-size:13px; color:#0b3a66; margin:6px 0 0 0; }

@media (max-width:640px){
  .modal { padding:12px; }
}

/* Permite scroll no conte√∫do interno do modal */
.modal-body {
    max-height: 80vh;
    overflow-y: auto;
    padding-right: 6px;
}

</style>
</head>

<body>
<div class="container">
    <h1>üìå Relat√≥rio por Almoxarifado.</h1>

    <div class="filtros-botoes">

        <input type="file" id="fileInput" accept=".xlsx">

        <select id="filtroCliente" multiple><option value="">Cliente</option></select>

        <select id="filtroAlmox"><option value="">Almoxarifado</option></select>

        <input type="number" id="diasCorte" placeholder="Dias de Corte" min="1">

        <button onclick="baixarExcel()">üíæ Excel</button>
        <button onclick="gerarRelatorioImpressao()">üñ®Ô∏è Imprimir</button>
        <button onclick="toggleDetalhes()" id="btnToggle">‚¨ÜÔ∏è Expandir/Recolher Todos</button>
        <button onclick="mostrarResumoGeral()">üìä Resumo Geral</button>

    </div>

    <div id="resultado"></div>
</div>


<script>
let dfGlobal = [];
let ordenacao = { coluna: null, asc: true };

const COLUNAS_DATA = [
    "Data de Check in","Data de Entrada da Nota","Data Inventario",
    "Ultimo Inventario Filial","Data de Cria√ß√£o da Coleta",
    "Data Programacao","Dt Final Entrega","Dt Limite Embarque"
];

const COLUNAS_EXCEL = [
    "Data de Check in","Data de Entrada da Nota","Nota","Numero OEF","Range de Dias",
    "Fornecedor","Almoxarifado","CTE","ONU","End. WMS","Mercadoria","Peso","Volumes",
    "Data Inventario","Ultimo Inventario Filial","Status no Inventario"
];

function formatDateBR(date){
    if(!date) return "";
    const d = String(date.getDate()).padStart(2,"0");
    const m = String(date.getMonth()+1).padStart(2,"0");
    return `${d}/${m}/${date.getFullYear()}`;
}

/*
  parseDateLocal aprimorada:
*/
function parseDateLocal(val){
    if(val === null || val === undefined) return null;
    if(val instanceof Date && !isNaN(val)) return new Date(val.getFullYear(), val.getMonth(), val.getDate());
    if(typeof val === "number" && !isNaN(val)){
        const d = new Date(Math.round((val - 25569) * 86400 * 1000));
        if(!isNaN(d)) return new Date(d.getFullYear(), d.getMonth(), d.getDate());
        return null;
    }
    if(typeof val === "string"){
        const s = val.trim();
        if(s.includes("/")){
            const parts = s.split(" ");
            const datePart = parts[0];
            const comps = datePart.split("/");
            if(comps.length === 3){
                const d = parseInt(comps[0],10);
                const m = parseInt(comps[1],10) - 1;
                const y = parseInt(comps[2],10);
                if(!isNaN(d) && !isNaN(m) && !isNaN(y)) return new Date(y, m, d);
            }
        }
        const maybe = new Date(s);
        if(!isNaN(maybe)) return new Date(maybe.getFullYear(), maybe.getMonth(), maybe.getDate());
    }
    return null;
}

document.getElementById("fileInput").addEventListener("change", async function(e){
    const file = e.target.files[0];
    if(!file) return;

    const data = await file.arrayBuffer();
    const workbook = XLSX.read(data, { cellDates:true, raw:true });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];

    let df = XLSX.utils.sheet_to_json(sheet, { raw:true, dateNF:"dd/mm/yyyy" });
    df = df.filter(l => l["Numero OEF"] && String(l["Numero OEF"]).trim() !== "");

    // üî• REMOVER DUPLICADOS (mesma Nota + Numero OEF)
    const seen = new Set();
    df = df.filter(linha => {
        const chave = `${linha["Nota"]}__${linha["Numero OEF"]}`;
        if (seen.has(chave)) return false; // j√° existe ‚Üí descartar
        seen.add(chave);
        return true; // manter
    });


    df.forEach(linha => {
        linha["Data de Entrada da Nota"] = parseDateLocal(linha["Data de Entrada da Nota"]);
        if (linha["Data de Entrada da Nota"] instanceof Date) {
            linha["Data de Entrada da Nota"].setDate(linha["Data de Entrada da Nota"].getDate() + 1);
        }
        linha["Data de Check in"] = parseDateLocal(linha["Data de Check in"]);
        COLUNAS_DATA.forEach(col => {
            if(col !== "Data de Entrada da Nota" && col !== "Data de Check in"){
                linha[col] = parseDateLocal(linha[col]);
            }
        });
    });

    df.forEach(linha => {
        const dEntrada = linha["Data de Entrada da Nota"] instanceof Date ? linha["Data de Entrada da Nota"] : null;
        const dCheck   = linha["Data de Check in"] instanceof Date ? linha["Data de Check in"] : null;
        let maiorData = null;
        if (dEntrada && dCheck) maiorData = dEntrada > dCheck ? dEntrada : dCheck;
        else if (dEntrada) maiorData = dEntrada;
        else if (dCheck) maiorData = dCheck;

        if (maiorData) {
            const hoje = new Date(); hoje.setHours(0,0,0,0);
            const diff = Math.round((hoje - maiorData) / (1000*60*60*24));
            linha["Range de Dias"] = diff;
        } else {
            linha["Range de Dias"] = "";
        }
    });

    dfGlobal = df;
    renderTabela();
});

// ------------------- FILTROS -------------------
function preencherFiltros(df, filtroAlmoxSelecionado, filtroRangeSelecionado){
    const filtroAlmox = document.getElementById("filtroAlmox");

    filtroAlmox.innerHTML = `<option value="">Almoxarifado</option>`;

    const val = document.getElementById("diasCorte").value;
    const corteDias = val === "" ? null : parseInt(val);

    const hoje = new Date(); hoje.setHours(0,0,0,0);
    const limite = (corteDias !== null && !isNaN(corteDias)) ? new Date(hoje.getTime()) : null;
    if(limite) limite.setDate(hoje.getDate() - corteDias);

    const clientesSelecionados = $('#filtroCliente').val() || [];

    const dfFiltrado = df.filter(l => {

        if (clientesSelecionados.length > 0 &&
            !clientesSelecionados.includes(String(l["Cliente"])))
            return false;

        if(filtroAlmoxSelecionado && l["Almoxarifado"] !== filtroAlmoxSelecionado)
            return false;

        const dEntrada = l["Data de Entrada da Nota"];
        const dCheckin = l["Data de Check in"];

        if (corteDias !== null && limite) {
            const maiorData =
                (dEntrada instanceof Date && !isNaN(dEntrada) &&
                dCheckin instanceof Date && !isNaN(dCheckin))
                    ? (dEntrada > dCheckin ? dEntrada : dCheckin)
                    : (dEntrada instanceof Date && !isNaN(dEntrada) ? dEntrada :
                    dCheckin instanceof Date && !isNaN(dCheckin) ? dCheckin : null);

            if (!maiorData) return false;
            return maiorData.getTime() <= limite.getTime();
        }

        return true;
    });


    const almoxSet = new Set(dfFiltrado.map(l => l["Almoxarifado"]).filter(a => a));

    [...almoxSet].sort().forEach(a => {
        filtroAlmox.innerHTML += `<option value="${a}" ${filtroAlmoxSelecionado===a?'selected':''}>${a}</option>`;
    });

    filtroAlmox.onchange = renderTabela;
    document.getElementById("diasCorte").onchange = renderTabela;

    // ------- CLIENTES (NOVA PARTE) --------
    const filtroCliente = document.getElementById("filtroCliente");

    // captura sele√ß√£o atual (se houver) para preservar
    const prevSelected = $('#filtroCliente').val() || [];

    // limpa
    $('#filtroCliente').empty();

    // Lista deve ser SEMPRE baseada no dfGlobal ‚Äî nunca no dfFiltrado!
    const clientesSet = new Set(dfGlobal.map(l => l["Cliente"]).filter(c => c));


    [...clientesSet].sort().forEach(c => {
        // cria option via jQuery para evitar problemas com select2
        const option = new Option(c, c, false, prevSelected.includes(String(c)));
        $('#filtroCliente').append(option);
    });

    // se estiver usando Select2, informar que o conte√∫do mudou
    if ($('#filtroCliente').data('select2')) {
        $('#filtroCliente').trigger('change.select2');
    } else {
        // se Select2 ainda n√£o inicializado, manter onchange normal
        $('#filtroCliente').on('change', renderTabela);
    }


}

// ------------------- RENDER TABELA -------------------
function renderTabela(){
    const filtroAlmox = document.getElementById("filtroAlmox").value;
    const clientesSelecionados = $('#filtroCliente').val() || [];


    preencherFiltros(dfGlobal, filtroAlmox, null);


    const val = document.getElementById("diasCorte").value;
    const corteDias = val === "" ? null : parseInt(val);

    const hoje = new Date(); hoje.setHours(0,0,0,0);
    const limite = (corteDias !== null && !isNaN(corteDias)) ? new Date(hoje.getTime()) : null;
    if(limite) limite.setDate(hoje.getDate() - corteDias);

    const dfFiltrado = dfGlobal.filter(l => {
        if(filtroAlmox && l["Almoxarifado"] !== filtroAlmox) return false;
        if(clientesSelecionados.length > 0 && !clientesSelecionados.includes(String(l["Cliente"]))) return false;


        const dEntrada = l["Data de Entrada da Nota"];
        const dCheckin = l["Data de Check in"];

        if (corteDias !== null && limite) {
            const maiorData =
                (dEntrada instanceof Date && !isNaN(dEntrada) &&
                dCheckin instanceof Date && !isNaN(dCheckin))
                    ? (dEntrada > dCheckin ? dEntrada : dCheckin)
                    : (dEntrada instanceof Date && !isNaN(dEntrada) ? dEntrada :
                    dCheckin instanceof Date && !isNaN(dCheckin) ? dCheckin : null);

            if (!maiorData) return false;
            return maiorData.getTime() <= limite.getTime();
        }
        return true;
    });

    const todasColunas = Array.from(new Set(dfGlobal.flatMap(obj => Object.keys(obj))));
    const colunasOrdenadas = [
        "Almoxarifado","Range de Dias","Nota","Data de Entrada da Nota","Data de Check in",
        ...todasColunas.filter(c => ![
            "Almoxarifado","Range de Dias","Nota","Data de Entrada da Nota","Data de Check in"
        ].includes(c))
    ];

    const grupos = {};
    dfFiltrado.forEach(l => {
        const key = l["Almoxarifado"] || "Sem Almoxarifado";
        if(!grupos[key]) grupos[key] = [];
        grupos[key].push(l);
    });

    let html = "";
    Object.keys(grupos).sort().forEach(almox => {
        let grupo = [...grupos[almox]];
        if (ordenacao.coluna) grupo = ordenarArray(grupo, ordenacao.coluna, ordenacao.asc);

        const notas = grupo.length;
        const totalPeso = grupo.reduce((s,l)=>s+(parseFloat(l["Peso"])||0), 0);
        const totalVolumes = grupo.reduce((s,l)=>s+(parseFloat(l["Volumes"])||0), 0);

        html += `<details><summary>üì¶ ${almox} ‚Äî ${notas} notas</summary>`;
        html += `<div class="summary-resumo">Resumo: Total Notas: ${notas} | Peso: ${totalPeso.toFixed(2)} | Volumes: ${Number(totalVolumes).toFixed(2)}</div>`;
        html += `<div class="tabela-scroll"><table><tr>`;
        
        colunasOrdenadas.forEach(c => {
            html += `<th onclick="clicarCabecalho('${c}')">${c}${ordenacao.coluna===c ? (ordenacao.asc?' üîº':' üîΩ') : ''}</th>`;
        });

        html += `</tr>`;

        grupo.forEach(l => {
            html += "<tr>" + colunasOrdenadas.map(c=>{
                const val = l[c];
                return COLUNAS_DATA.includes(c)
                    ? `<td>${formatDateBR(val)}</td>`
                    : `<td>${val ?? ""}</td>`;
            }).join("") + "</tr>";
        });

        html += `</table></div></details><br>`;
    });


    document.getElementById("resultado").innerHTML = html;

    // manter comportamento: abrir todos
    document.querySelectorAll("details").forEach(d => d.open = true);
    atualizarBotaoToggle();
}

function ordenarArray(arr, coluna, asc = true){
    return arr.sort((a,b)=>{
        let A = a[coluna] ?? "";
        let B = b[coluna] ?? "";
        if(A instanceof Date && B instanceof Date) return asc ? A-B : B-A;
        const nA = parseFloat(A);
        const nB = parseFloat(B);
        if(!isNaN(nA) && !isNaN(nB)) return asc ? nA-nB : nB-nA;
        A = String(A).toLowerCase();
        B = String(B).toLowerCase();
        return asc ? A.localeCompare(B) : B.localeCompare(A);
    });
}

// ------------------- ORDENA√á√ÉO CABE√áALHO -------------------
function clicarCabecalho(coluna){
    if(ordenacao.coluna === coluna) ordenacao.asc = !ordenacao.asc;
    else { ordenacao.coluna = coluna; ordenacao.asc = true; }
    renderTabela();
}

// ------------------- ABRIR / FECHAR TODOS -------------------
function toggleDetalhes(){
    const details = document.querySelectorAll("details");
    const abrir = Array.from(details).some(d => !d.open);
    details.forEach(d => d.open = abrir);
    atualizarBotaoToggle();
}

function atualizarBotaoToggle(){
    const all = document.querySelectorAll("details");
    const btn = document.getElementById("btnToggle");
    const todosAbertos = Array.from(all).every(d => d.open);
    btn.innerText = todosAbertos ? "‚¨áÔ∏è Recolher Todos" : "‚¨ÜÔ∏è Expandir Todos";
}

// ------------------- EXPORTAR EXCEL -------------------
function baixarExcel(){
    const data = [];

    document.querySelectorAll("details").forEach(detail => {
        if(detail.open){
            const table = detail.querySelector("table");
            const rows = Array.from(table.querySelectorAll("tr")).slice(1);

            rows.forEach(tr => {
                const rowData = Array.from(tr.querySelectorAll("td")).map(td => td.innerText);
                const obj = {};
                COLUNAS_EXCEL.forEach(col => {
                    const index = Array.from(table.querySelectorAll("th"))
                        .findIndex(th => th.innerText === col);
                    obj[col] = index >= 0 ? rowData[index] : "";
                });
                data.push(obj);
            });
        }
    });

    if(data.length === 0){ alert("Nenhum relat√≥rio aberto para exportar!"); return; }

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Relatorio");
    XLSX.writeFile(wb, "relatorio_aberto.xlsx");
}

// ------------------- IMPRESS√ÉO -------------------
function gerarRelatorioImpressao(){
    const grupos = {};

    document.querySelectorAll("details").forEach(detail => {
        if(detail.open){
            const table = detail.querySelector("table");
            const almox = detail.querySelector("summary").innerText.split(' ‚Äî ')[0].replace("üì¶ ","");
            if(!grupos[almox]) grupos[almox] = [];
            const rows = Array.from(table.querySelectorAll("tr")).slice(1);
            rows.forEach(tr => {
                const rowData = Array.from(tr.querySelectorAll("td")).map(td => td.innerText);
                const obj = {};
                COLUNAS_EXCEL.forEach(col => {
                    const idx = Array.from(table.querySelectorAll("th"))
                        .findIndex(th => th.innerText === col);
                    obj[col] = idx >= 0 ? rowData[idx] : "";
                });
                grupos[almox].push(obj);
            });
        }
    });

    if(Object.keys(grupos).length === 0){
        alert("Nenhum relat√≥rio aberto para imprimir!");
        return;
    }

    let htmlPrint = `<html><head><title>Relat√≥rio para Impress√£o</title><style>
        table { width:100%; border-collapse:collapse; font-size:10px; margin-bottom:25px; }
        th, td { border:1px solid #000; padding:3px; text-align:center; }
        th { background:#1976d2; color:white; font-weight:600; }
        h3 { margin-top:15px; margin-bottom:5px; font-size:12px; }
        h2 { font-size:14px; text-align:center; margin-bottom:15px; }
    </style></head><body>`;

    htmlPrint += `<h2>üìå Relat√≥rio por Almoxarifado</h2>`;

    for(const almox in grupos){
        htmlPrint += `<h3>üì¶ ${almox} ‚Äî ${grupos[almox].length} notas</h3>`;
        htmlPrint += `<table><tr>${COLUNAS_EXCEL.map(c=>`<th>${c}</th>`).join("")}</tr>`;
        grupos[almox].forEach(r => {
            htmlPrint += `<tr>${COLUNAS_EXCEL.map(c=>`<td>${r[c] ?? ""}</td>`).join("")}</tr>`;
        });
        htmlPrint += `</table>`;
    }

    htmlPrint += `</body></html>`;

    const w = window.open();
    w.document.write(htmlPrint);
    w.document.close();
    w.focus();
    w.print();
}

/*
====================================================
‚≠ê PATCH ‚Äî IMPEDIR FECHAMENTO AO CLICAR NO <TH> ‚≠ê
====================================================
*/
document.addEventListener("click", function(e) {
    if (e.target.tagName === "TH") {
        e.stopPropagation();
    }
}, true);

document.addEventListener("click", function (e) {
    document.querySelectorAll("details").forEach(det => {
        const summary = det.querySelector("summary");
        const clicouResumo = e.target === summary || summary.contains(e.target);
        if (clicouResumo) {
            e.preventDefault();
            det.open = !det.open;
        }
    });
});

document.addEventListener("toggle", function (e) {
    if (e.target.tagName === "DETAILS") {
        e.stopImmediatePropagation();
    }
}, true);

/*
====================================================
|  Fun√ß√µes extra para gerar o chart (popup)       |
====================================================
*/

// Retorna os dados atualmente exibidos (mesma l√≥gica de filtro do renderTabela)
function getCurrentFilteredData(){
    const filtroAlmox = document.getElementById("filtroAlmox").value;
    const val = document.getElementById("diasCorte").value;
    const corteDias = val === "" ? null : parseInt(val);

    const clientesSelecionados = $('#filtroCliente').val() || [];

    const hoje = new Date(); 
    hoje.setHours(0,0,0,0);

    const limite = (corteDias !== null && !isNaN(corteDias))
        ? new Date(hoje.getTime())
        : null;

    if(limite) limite.setDate(hoje.getDate() - corteDias);

    const filtered = dfGlobal.filter(l => {

        // ‚úÖ FILTRO POR CLIENTE ‚Äî FALTAVA AQUI
        if(clientesSelecionados.length > 0 &&
           !clientesSelecionados.includes(String(l["Cliente"])))
            return false;

        // j√° existia
        if(filtroAlmox && l["Almoxarifado"] !== filtroAlmox)
            return false;

        // filtro por dias de corte
        const dEntrada = l["Data de Entrada da Nota"];
        const dCheckin = l["Data de Check in"];

        if (corteDias !== null && limite) {
            const maiorData =
                (dEntrada instanceof Date && !isNaN(dEntrada) &&
                dCheckin instanceof Date && !isNaN(dCheckin))
                    ? (dEntrada > dCheckin ? dEntrada : dCheckin)
                    : (dEntrada instanceof Date && !isNaN(dEntrada) ? dEntrada :
                    dCheckin instanceof Date && !isNaN(dCheckin) ? dCheckin : null);

            if (!maiorData) return false;
            return maiorData.getTime() <= limite.getTime();
        }

        return true;
    });

    return filtered;
}


// Constr√≥i a matriz de contagens: almoxarifado x range
function buildChartCounts(filteredData){
    const rangeGroups = {
        "0‚Äì5 dias":   d => d >= 0 && d <= 5,
        "6‚Äì10 dias":  d => d >= 6 && d <= 10,
        "11‚Äì20 dias": d => d >= 11 && d <= 20,
        "21+ dias":   d => d >= 21
    };

    const almoxs = Array.from(new Set(filteredData.map(r => r["Almoxarifado"] || "Sem Almoxarifado"))).sort();
    const counts = {};
    Object.keys(rangeGroups).forEach(r => counts[r] = almoxs.map(() => 0));

    filteredData.forEach(row => {
        const alm = row["Almoxarifado"] || "Sem Almoxarifado";
        const dias = row["Range de Dias"];
        if (dias === "" || dias === null || isNaN(dias)) return;
        const i = almoxs.indexOf(alm);
        if (i < 0) return;
        for (const group in rangeGroups) {
            if (rangeGroups[group](dias)) {
                counts[group][i]++;
                break;
            }
        }
    });

    return { almoxs, ranges: Object.keys(rangeGroups), counts };
}

// Gera resumo detalhado textual (Geral, por almoxarifado, por range)
function buildSummaryText(filteredData){
    const resumo = {
        totalNotas: 0,
        totalPeso: 0,
        totalVolumes: 0,
        totalValor: 0,
        porAlmox: {},
        porRange: { "0‚Äì5 dias":0, "6‚Äì10 dias":0, "11‚Äì20 dias":0, "21+ dias":0 }
    };


    const rangeGroups = {
        "0‚Äì5 dias":   d => d >= 0 && d <= 5,
        "6‚Äì10 dias":  d => d >= 6 && d <= 10,
        "11‚Äì20 dias": d => d >= 11 && d <= 20,
        "21+ dias":   d => d >= 21
    };

    filteredData.forEach(r => {
        resumo.totalNotas += 1;
        resumo.totalPeso += parseFloat(r["Peso"]) || 0;
        resumo.totalVolumes += parseFloat(r["Volumes"]) || 0;
        resumo.totalValor += parseFloat(r["Valor Nota"]) || 0;


        const alm = r["Almoxarifado"] || "Sem Almoxarifado";
        if(!resumo.porAlmox[alm]) resumo.porAlmox[alm] = { notas:0, peso:0, volumes:0 };
        resumo.porAlmox[alm].notas += 1;
        resumo.porAlmox[alm].peso += parseFloat(r["Peso"]) || 0;
        resumo.porAlmox[alm].volumes += parseFloat(r["Volumes"]) || 0;
        resumo.porAlmox[alm].valor = (resumo.porAlmox[alm].valor || 0) + (parseFloat(r["Valor Nota"]) || 0); 


        const dias = r["Range de Dias"];
        if(!(dias === "" || dias === null || isNaN(dias))){
            for(const key in rangeGroups){
                if(rangeGroups[key](dias)){
                    resumo.porRange[key] += 1;
                    break;
                }
            }
        }
    });

    // NOVO: distribuir por almoxarifado + range
    resumo.porAlmoxRange = {};
    const rangesKeys = Object.keys(rangeGroups);

    filteredData.forEach(r => {
        const alm = r["Almoxarifado"] || "Sem Almoxarifado";
        const dias = r["Range de Dias"];

        if(!resumo.porAlmoxRange[alm]) {
            resumo.porAlmoxRange[alm] = {
                "0‚Äì5 dias": 0,
                "6‚Äì10 dias": 0,
                "11‚Äì20 dias": 0,
                "21+ dias": 0
            };
        }

        if(!(dias === "" || dias === null || isNaN(dias))) {
            for(const key in rangeGroups){
                if(rangeGroups[key](dias)){
                    resumo.porAlmoxRange[alm][key]++;
                    break;
                }
            }
        }
    });

    return resumo;
}

let currentChart = null;

// Cria e abre modal + chart + resumo (resumo ficar√° abaixo do gr√°fico conforme pedido ‚Äî op√ß√£o 2)
function openChartModalWithSummary(){
    const filtered = getCurrentFilteredData(); // mant√©m para seguran√ßa
    // usar exatamente a mesma filtragem da tabela
    const tabelaFiltrada = getCurrentFilteredData();

    const { almoxs, ranges, counts } = buildChartCounts(tabelaFiltrada);
    // ‚≠ê Ajusta largura m√≠nima por quantidade de barras
    const minBarWidth = 60;
    const totalBars = almoxs.length;
    


    if(almoxs.length === 0){
        alert("Nenhum dado para exibir no gr√°fico (verifique filtros).");
        return;
    }

    // Build summary text structure
    const resumo = buildSummaryText(tabelaFiltrada);


    // montar modal
    const overlay = document.createElement("div");
    overlay.className = "modal-overlay";
    overlay.id = "chart-modal-overlay";

    overlay.innerHTML = `
      <div class="modal" role="dialog" aria-modal="true">
        <div class="modal-header">
          <div class="modal-title">Resumo Geral ‚Äî Gr√°fico por Almoxarifado / Range de Dias</div>
          <button class="modal-close" id="chart-modal-close">Fechar</button>
        </div>
        <div class="modal-body">
        <div style="overflow-x:auto; width:100%; padding-bottom:10px;">
            <div id="chart-container" style="min-width:1200px; height:500px;">
                <canvas id="resumoChart"></canvas>
            </div>
        </div>

          <div class="chart-legend" id="chart-legend"></div>

          <!-- RESUMO DETALHADO (ABAIXO DO GR√ÅFICO) -->
          <div class="modal-summary" id="modal-summary">
            <h2>Resumo Geral</h2>
            <div id="resumo-geral-text"></div>

            <h2>Resumo por Almoxarifado</h2>
            <pre id="resumo-por-almox"></pre>

            <h2>Total Geral por Range de Dias</h2>
            <pre id="resumo-por-range"></pre>
            <h2>Detalhamento por Range em Cada Almoxarifado</h2>
            <pre id="resumo-por-almox-range"></pre>
          </div>
        </div>
      </div>
    `;

    document.body.appendChild(overlay);

    // s√≥ agora o elemento existe
    document.querySelector("#chart-container").style.minWidth =
        (totalBars * minBarWidth) + "px";


    // montar datasets com palette
    const palette = {
        "0‚Äì5 dias":   "#1565C0",
        "6‚Äì10 dias":  "#2E7D32",
        "11‚Äì20 dias": "#F9A825",
        "21+ dias":   "#C62828"
    };

    const datasets = ranges.map(r => ({
        label: r,
        data: counts[r],
        backgroundColor: palette[r],
        borderColor: palette[r],
        borderWidth: 1,
        stack: "Stack 0"
    }));

    const ctx = document.getElementById("resumoChart").getContext("2d");
    if(currentChart){
        try { currentChart.destroy(); } catch(e){}
        currentChart = null;
    }

    currentChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: almoxs,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { position: 'top' },
                tooltip: { enabled: true },
                datalabels: {
                    color: '#000',
                    anchor: 'center',
                    align: 'center',
                    font: { weight: 'bold', size: 11 },
                    formatter: value => (value > 0 ? value : '')
                }
            },
            scales: {
                x: { stacked: true, title: { display: true, text: 'Almoxarifado' } },
                y: { stacked: true, title: { display: true, text: 'N√∫mero de Notas' }, beginAtZero: true }
            }
        },
        plugins: [ChartDataLabels]
    });

    // legend HTML
    const legendDiv = document.getElementById("chart-legend");
    legendDiv.innerHTML = ranges.map(r => `<span style="display:inline-block;margin-right:8px;padding:6px 10px;border-radius:8px;background:#f1f1f1;margin-bottom:6px;">${r}</span>`).join("");

    // preencher resumo detalhado (ABAIXO DO GR√ÅFICO)
    document.getElementById("resumo-geral-text").innerHTML =
        `Almoxarifados exibidos: <strong>${Object.keys(resumo.porAlmox).length}</strong> &nbsp;|&nbsp; 
        Total de Notas: <strong>${resumo.totalNotas}</strong> &nbsp;|&nbsp; 
        Peso Total: <strong>${resumo.totalPeso.toFixed(2)}</strong> &nbsp;|&nbsp; 
        Volumes Totais: <strong>${resumo.totalVolumes}</strong>
        &nbsp;|&nbsp; Valor Total: <strong>R$ ${resumo.totalValor.toLocaleString('pt-BR',{minimumFractionDigits:2})}</strong>`;


    const porAlmoxText = Object.keys(resumo.porAlmox).sort().map(a => {
        const v = resumo.porAlmox[a];
        return `${a} ‚Äî ${v.notas} notas | ${v.peso.toFixed(2)} kg | ${v.volumes} volumes | Valor Total: R$ ${ (v.valor || 0).toLocaleString('pt-BR',{minimumFractionDigits:2}) }` ;
    }).join("\n");
    document.getElementById("resumo-por-almox").innerText = porAlmoxText || "‚Äî";

    const porRangeText = Object.keys(resumo.porRange).map(r => `${r}: ${resumo.porRange[r]} notas`).join("\n");
    document.getElementById("resumo-por-range").innerText = porRangeText || "‚Äî";

    // NOVO ‚Äî preencher resumo por almoxarifado + range
    let txtAlmoxRange = "";
    const almoxOrdenados = Object.keys(resumo.porAlmoxRange).sort();

    almoxOrdenados.forEach(alm => {
        txtAlmoxRange += `${alm}\n`;
        const ranges = resumo.porAlmoxRange[alm];
        txtAlmoxRange += `  0‚Äì5 dias:   ${ranges["0‚Äì5 dias"]}\n`;
        txtAlmoxRange += `  6‚Äì10 dias:  ${ranges["6‚Äì10 dias"]}\n`;
        txtAlmoxRange += `  11‚Äì20 dias: ${ranges["11‚Äì20 dias"]}\n`;
        txtAlmoxRange += `  21+ dias:   ${ranges["21+ dias"]}\n\n`;
    });

    document.getElementById("resumo-por-almox-range").textContent = txtAlmoxRange;

    

    // evento de fechamento
    document.getElementById("chart-modal-close").onclick = () => closeChartModal();
    overlay.onclick = (ev) => {
        if(ev.target === overlay) closeChartModal();
    };
}

function closeChartModal(){
    const overlay = document.getElementById("chart-modal-overlay");
    if(overlay){
        if(currentChart){
            try { currentChart.destroy(); } catch(e){/*ignore*/ }
            currentChart = null;
        }
        overlay.remove();
    }
}

// ---------------- Mostrar Resumo + abrir popup ----------------
function mostrarResumoGeral(){
    // Toggle: se modal j√° existe, fecha; caso contr√°rio abre
    const existente = document.getElementById("chart-modal-overlay");
    if (existente) {
        closeChartModal();
        return;
    }
    // abre modal com gr√°fico e resumo (resumo abaixo do gr√°fico ‚Äî op√ß√£o 2)
    openChartModalWithSummary();
}

$(document).ready(function() {
    $('#filtroCliente').select2({
        placeholder: "Cliente",
        allowClear: true,
        width: 'resolve'
    });

    $('#filtroCliente').on('change', function() {
        renderTabela();
    });
});


</script>
</body>
</html>
